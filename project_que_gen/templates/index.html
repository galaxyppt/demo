<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Interview</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7fb;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            position: relative;
        }

        .container {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 900px;
            padding: 30px;
            text-align: center;
            box-sizing: border-box;
            position: relative;
        }

        .title {
            font-size: 36px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }

        .subtitle {
            font-size: 18px;
            color: #888;
            margin-bottom: 40px;
        }

        #question {
            font-size: 24px;
            font-weight: 500;
            color: #555;
            border-right: none;
            width: 100%;
            animation: none;
            word-wrap: break-word;
            white-space: normal;
            text-align: center;
            margin-bottom: 20px;
        }

        @keyframes typing {
            from {
                width: 0;
            }
            to {
                width: 100%;
            }
        }

        #video {
            width: 100%;
            max-width: 600px;
            height: 340px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            background: #000;
            margin-top: 20px;
            display: none;
            transition: opacity 1s ease;
            margin-left: auto;
            margin-right: auto;
        }

        .microphone-btn {
            background-color: #007BFF;
            margin-top: 30px;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: inline-block;
            margin: 0 auto;
        }

        .microphone-btn:hover {
            background-color: #0056b3;
        }

        .microphone-btn:disabled {
            background-color: #c6c6c6;
            cursor: not-allowed;
        }

        button {
            background-color: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #218838;
        }

        .result-container {
            display: none;
            text-align: center;
            margin-top: 30px;
        }

        .result-container h2 {
            font-size: 30px;
            font-weight: 700;
        }

        .result-container p {
            font-size: 20px;
            color: #333;
        }

        /* Style for the smaller webcam circle at the bottom right */
        #candidateVideo {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid #007BFF;
            object-fit: cover;
            display: none; /* Hidden initially */
        }

        #roleSelect {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #007BFF;
            border-radius: 8px;
            background-color: #fff;
            color: #333;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            position: relative;
        }

        #roleSelect:focus {
            border-color: #0056b3;
            box-shadow: 0 0 8px rgba(0, 91, 187, 0.3);
        }

        #roleSelect:hover {
            border-color: #0056b3;
        }

        .role-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; /* Adds spacing */
            margin-bottom: 20px;
        }

        .container select {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="%23007BFF"><path d="M7 10l5 5 5-5H7z"></path></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        #resumeUpload {
            display: none; /* Hide default input */
        }

        .custom-file-upload {
            background-color: #007BFF;
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            display: inline-block;
            transition: background-color 0.3s ease;
            text-align: center;
        }

        .custom-file-upload:hover {
            background-color: #0056b3;
        }

    </style>
</head>
<body>

    <div class="container">
        <div class="title">Boost your interview preparation with AI</div>

        <div class="video-call-frame">
            <video id="video" autoplay></video>
        </div>

        <div id="question"></div>

        <div class="subtitle">Select a role you want to prepare for and also upload your RESUME'</div>
        <div class="role-container" id="roleContainer">
            
            <select id="roleSelect">
                <option value="" disabled selected>Select Role</option>
                <option>Data Analyst</option>
                <option>Business Analyst</option>
                <option>Data Scientist (Entry-Level)</option>
                <option>Data Engineer (Junior)</option>
                <option>BI Analyst (Power BI, Tableau, or Grafana)</option>
                <option>SQL Data Analyst</option>
                <option>Product Analyst</option>
                <option>Marketing Analyst</option>
                <option>Financial Analyst (with Data skills)</option>
                <option>Risk Analyst</option>
                <option>AI Engineer (Junior)</option>
                <option>Machine Learning Engineer (Entry-Level)</option>
                <option>Computer Vision Engineer (Entry-Level)</option>
                <option>NLP Engineer (Entry-Level)</option>
                <option>Deep Learning Engineer (Beginner Level)</option>
                <option>AI Research Associate</option>
                <option>AI/ML Data Annotator (for AI model training)</option>
                <option>Python Developer (Data/AI-focused)</option>
                <option>Data Automation Engineer</option>
                <option>ETL Developer</option>
            </select>

            <label for="resumeUpload" class="custom-file-upload" id="resumeLabel">Upload Resume (PDF)</label>
            <input type="file" id="resumeUpload" accept=".pdf" onchange="updateResumeLabel()">

            <button onclick="submitForm()">Start Your Preparation</button>
        </div>

        <button class="microphone-btn" id="microphoneBtn" onclick="startSpeechRecognition()" disabled style="display: none;">Speak Your Response</button>
    </div>

    <div class="result-container" id="resultContainer">
        <h2>Interview Complete</h2>
        <p>You have completed the interview. Thank you for your time!</p>
        <p>Your responses will be evaluated, and feedback will be provided shortly.</p>
    </div>

    <!-- Live Webcam Video -->
    <video id="candidateVideo" autoplay muted></video>

    <script>
        function submitForm() {
            const role = document.getElementById('roleSelect').value;
            const resumeInput = document.getElementById('resumeUpload');
            
            if (!role) {
                alert("Please select a role.");
                return;
            }

            if (resumeInput.files.length === 0) {
                alert("Please upload a resume.");
                return;
            }

            const formData = new FormData();
            formData.append('role', role);
            formData.append('resume', resumeInput.files[0]);

            fetch('/upload_resume', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                startInterview();  // Call your function to start the interview
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        const microphoneButton = document.getElementById('microphoneBtn');
        const videoElement = document.getElementById('video');
        const resultContainer = document.getElementById('resultContainer');
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        let questionIndex = 0;
        let questionCount = 0;
        let timeoutId;
        let pauseTimer;
        let responseTimeout;
        const PAUSE_TIME =3500; // 5 seconds for pause detection
        const RESPONSE_TIMEOUT = 35000; // 35 seconds timeout for response

        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onresult = (event) => {
            const responseText = event.results[0][0].transcript;
            console.log('Recognized Speech: ', responseText);
            getNextQuestion(responseText);
            resetPauseTimer(); // Reset pause timer if speech is detected
        };

        recognition.onerror = (event) => {
            console.error("Speech recognition error", event.error);
            alert("There was an issue with the speech recognition. Please try again.");
        };

        recognition.onend = () => {
            // Start a pause timer when speech recognition ends
            startPauseTimer();
        };

        function startSpeechRecognition() {
            microphoneButton.disabled = true;
            recognition.start();
            startResponseTimeout(); // Start the timeout when speech recognition is initiated
        }

        function startPauseTimer() {
            // If no speech for 3.5 seconds, move to next question
            pauseTimer = setTimeout(() => {
                console.log("No speech detected for 3.5 seconds, moving to next question.");
                showNextQuestion();
            }, PAUSE_TIME); // 3.5-second pause
        }

        function resetPauseTimer() {
            // Reset the pause timer if speech is detected
            clearTimeout(pauseTimer);
            startPauseTimer();
        }

        function startResponseTimeout() {
            // If no response is given within 35 seconds, proceed to the next question
            responseTimeout = setTimeout(() => {
                console.log("No response within 35 seconds, moving to next question.");
                showNextQuestion();
            }, RESPONSE_TIMEOUT); // 35-second response timeout
        }

        function resetResponseTimeout() {
            // Reset the 35-second timeout if a response is detected
            clearTimeout(responseTimeout);
            startResponseTimeout();
        }

        async function getNextQuestion(responseText = "") {
            if (questionCount >= 10) {
                // End the interview after 10 questions
                displayResult();
                return;
            }

            const response = await fetch('/process_response', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ response: responseText }),
            });

            const data = await response.json();

            if (data.error) {
                console.error("Error fetching next question:", data.error);
                alert("No more questions available or an error occurred.");
                return;
            }

            const nextQuestion = data.next_question;
            const videoSrc = data.video_src;

            document.getElementById('question').innerText = nextQuestion;

            videoElement.style.display = 'block';
            videoElement.src = videoSrc;
            videoElement.play();

            videoElement.onended = () => {
                // Reset the video source and ensure the video element is visible again
                videoElement.style.opacity = 0; // Hide the video initially
                videoElement.src = "/static/wait.mp4"; // Change the video source to wait.mp4

                // Wait until the video element is ready for the new source
                videoElement.oncanplaythrough = () => {
                    // Once the new video is ready to play, we can show it
                    videoElement.style.opacity = 1;
                    videoElement.style.display = 'block'; // Make sure it's displayed
                    videoElement.play(); // Start playing the wait video
                };
            };

            microphoneButton.disabled = false;
            questionCount++;
            resetResponseTimeout(); // Reset response timeout each time a new question appears
        }

        function showNextQuestion() {
            // Hide current question and video, then display the next question
            getNextQuestion(); // Proceed to next question
        }

        function displayResult() {
            // Hide the interview content and display the results
            document.querySelector('.container').style.display = 'none';
            resultContainer.style.display = 'block';
        }

        function startInterview() {
            questionCount = 0;  // Reset the question count
            getNextQuestion(); // Start with the first question

            // Hide the Start Interview button
            document.querySelector('button').style.display = 'none';

            // Hide role selection and resume upload elements
            document.getElementById('roleSelect').style.display = 'none';
            document.querySelector('.custom-file-upload').style.display = 'none';
            document.getElementById('resumeUpload').style.display = 'none';
            document.querySelector('.subtitle').style.display = 'none';

            // Show and enable the microphone button
            microphoneButton.style.display = 'block';
            microphoneButton.disabled = false;

            startCandidateVideo(); // Start webcam after starting the interview
            document.getElementById('candidateVideo').style.display = 'block'; // Show webcam feed
        }

        function startCandidateVideo() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                .then(stream => {
                    const candidateVideo = document.getElementById('candidateVideo');
                    candidateVideo.srcObject = stream;
                })
                .catch(err => {
                    console.error("Error accessing webcam:", err);
                    alert("Unable to access your webcam. Please check your settings.");
                });
        }

        function updateResumeLabel() {
            const fileInput = document.getElementById('resumeUpload');
            const label = document.getElementById('resumeLabel');

            if (fileInput.files.length > 0) {
                label.textContent = "Uploaded: " + fileInput.files[0].name;
                label.style.backgroundColor = "#28a745"; // Change color to indicate success
            }
        }

        function displayQuestion(questionText) {
            const questionDiv = document.getElementById("question");
            questionDiv.innerHTML = ""; // Clear previous content

            const words = questionText.split(" ");
            let line = "";

            words.forEach((word, index) => {
                line += word + " ";
                if ((index + 1) % 9 === 0 || index === words.length - 1) {
                    const p = document.createElement("p");
                    p.textContent = line.trim();
                    questionDiv.appendChild(p);
                    line = "";
                }
            });
        }

    </script>
</body>
</html>
